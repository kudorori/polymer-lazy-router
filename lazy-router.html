<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="./lazy-route.html">
<link rel="import" href="../iron-pages/iron-pages.html">

<!--
`lazy-router`


@demo demo/index.html
-->

<dom-module id="lazy-router">
  <template>
    <style>
      :host {
        display: block;
        height: 300px;
      }
    </style>
    <iron-pages
      selected="{{selected}}"
      selected-attribute="active">
      <slot></slot>
    </iron-pages>
  </template>

  <script>
    class lazyRouter extends Polymer.Element {
      static get is() { return 'lazy-router'; }
      static get properties() {
        return {
          render:{
            type: Boolean,
            value: false
          },
          route:{
            type: Object
          },
          prefix:{
            type: String,
            value: "",
            reflectToAttribute: true
          },
          selected:{
            type: String
          }
        };
      }
      
      static get observers(){
        return [
          "_bindRoute(route.path, render)"
        ]
      }
      
      static getStateForAction(action, state) {
        
      }
      
      connectedCallback(){
        super.connectedCallback();
        if(this.render){
          this.setPrefix("").then(function(){
            console.log(123);
          })
        }
      }
      
      setPrefix(prefix){
        this.prefix = prefix;
        var that = this;
        var routes = Array.from(that.querySelectorAll(":scope > lazy-route"));        
        return new Promise(function(resolve){
          that.render = false;
          Promise.all(routes.map(function(node){
            return node.setPrefix(prefix);
          })).then(function(){
            that.prefix = prefix;
            that.render = true;
            resolve();
          });
        })
      }
      
      _bindRoute(path, render){
        if(path==="undefined" || !render){
          return;
        }
        console.log("bindrouter");
        var routes = Array.from(this.querySelectorAll(":scope > lazy-route"));
        var index = routes.findIndex(function(item) {
          return item.match(path);
        });
        this.selected = index;
      }
      
    }

    window.customElements.define(lazyRouter.is, lazyRouter);
  </script>
</dom-module>


